<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Anon by pkholland</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Anon</h1>
        <h2>Experiments in Web Services Design</h2>
        <a href="https://github.com/pkholland/anon" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
        

<h1>
<a id="tech-overview" class="anchor" href="#tech-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>More Fun Timing Data
</h1>


<p>
It is, admittedly, a little unrealistic to just example how quickly simple i/o dispatching happens
in different designs if you are interested in how well an overall service will perform.  So what about
other operations that might be interesting to look into?  This page looks at a couple of others.
</p>

<ul>
  <li><a href="#context_create">Context Creation and Destruction</a></li>
  <li>Full-on http API servers</li>
</ul>

<h2>
<a id="context_create" class="anchor" href="#context_create" aria-hidden="true"><span class="octicon octicon-link"></span></a>Context Creation and Destruction
</h2>

<p>
A common point at which new "execution contexts" need to be created, or at least fetched from a
pool of previously constructed ones, is at the point when a new connection request comes into the server.
So, in the following sort of code:
</p>

<div class="highlight highlight-C++"><pre>
<span class="c1">// accept loop</span>
<span class="kt">void</span> <span class="nf">accept_loop</span>(<span class="k">int</span> listening_socket)
{
  <span class="k">while</span> (<span class="kc">true</span>) {
    <span class="kt">int</span> new_connection = <span class="nf">accept</span>(listening_socket, <span class="m">0</span>, <span class="m">0</span>);
    
    <span class="c1">// create a new "context" to handle this connection</span>
    std::thread(std::bind(<span class="nf">handle_message</span>, new_connection)).<span class="nf">detach</span>();
  }
}
</pre></div>

<p>
you can have code that creates a new thread, as shown in the code above, or you can do something else.
Regardless of what you do, you will need some kind of context-like object that keeps track of the state
of things as you process the messages you are going to receive.
</p>

<p>
Independent of whether you construct new object or pool them, it is interesting to understand the cost
of constructing new ones - since you will need to do this with some frequency.  So here is some data on
the cost of constructing new OS threads, as shown above vs. creating new anon fibers.
</p>

<p>
<table style="width:100%">
  <caption><b>Thread Creation vs. Fiber Creation</b></caption>
  <tr>
    <td></td>
    <td><b>1 Core</b></td>
    <td><b>2 Cores</b></td>
    <td><b>4 Cores</b></td>
  </tr>
  <tr>
    <td><b>Fibers</b></td>
    <td>3.7 - 3.8 secs.</td>
    <td>2.4 - 2.5 secs.</td>
    <td>2.3 - 2.4 secs.</td>
  </tr>
  <tr>
    <td><b>OS Threads</b></td>
    <td>8.7 - 9.0 secs.</td>
    <td>10.6 - 10.9 secs.</td>
    <td>12.4 - 17.2 secs.</td>
  </tr>
</table>
</p>


        </section>

        <aside id="sidebar">
          <a href="https://github.com/pkholland/anon/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/pkholland/anon/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/pkholland/anon"></a> is maintained by <a href="https://github.com/pkholland">pkholland</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
